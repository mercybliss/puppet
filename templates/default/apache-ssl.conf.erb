<IfModule mod_ssl.c>
    <VirtualHost _default_:443>
        ServerAdmin webmaster@localhost
        DocumentRoot <%= node['apache']['doc-root'] %>

        #--- Log Format, configuration and locations -----------------------#
        # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
        # error, crit, alert, emerg.
        # It is also possible to configure the loglevel for particular
        # modules, e.g.
        LogLevel info ssl:warn
        #LogLevel info

        # Flag requests from the loop-back interface (localhost 127.0.0.1)
        #SetEnvIf Remote_Addr "127\.0\.0\.1" dontlog
        #SetEnvIf Remote_Addr "::1" dontlog

        # Flag requests that are monitoring based (DD, Stackdriver, local ping)
        SetEnvIf User-agent .*ELB-HealthChecker*. monitoring
        SetEnvIf User-agent .*Datadog*. monitoring
        SetEnvIf User-agent .*dummy*. monitoring

        # Flag requests for the robots.txt file
        #SetEnvIf Request_URI "^/robots\.txt$" dontlog

        LogFormat "{\"time\":\"%t\", \"sourceIP\":\"%{X-Forwarded-For}i\", \"remoteIP\":\"%a\", \"host\":\"%V\", \"request\":\"%U\", \"query\":\"%q\", \"method\":\"%m\", \"status\":\"%>s\", \"userAgent\":\"%{User-agent}i\", \"referer\":\"%{Referer}i\", \"Duration\":\"%T.%D\" }" leapache

        ErrorLog ${APACHE_LOG_DIR}/error.log
        #CustomLog ${APACHE_LOG_DIR}/access.log leapache
        CustomLog ${APACHE_LOG_DIR}/access.log leapache env=!monitoring
        CustomLog ${APACHE_LOG_DIR}/monitoring-access.log leapache env=monitoring

        SSLEngine on

        SSLCertificateFile    /etc/ssl/certs/<%= node['deploy']['webapp']['environment']['site_address'] %>-crt.pem
        SSLCertificateKeyFile /etc/ssl/private/<%= node['deploy']['webapp']['environment']['site_address'] %>-key.pem
        <% if defined? node['deploy']['webapp']['ssl_certificate_ca'] && node['deploy']['webapp']['ssl_certificate_ca'] !="" %>
        SSLCertificateChainFile /etc/ssl/certs/<%= node['deploy']['webapp']['environment']['site_address'] %>-chain.pem
        <% end %>

        BrowserMatch "MSIE [2-6]" \
                nokeepalive ssl-unclean-shutdown \
                downgrade-1.0 force-response-1.0
        # MSIE 7 and newer should be able to use keepalive
        BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

        <Directory />
            Options FollowSymLinks MultiViews
            AllowOverride All
        </Directory>

        <Directory <%= node['apache']['doc-root'] %>/>
            Options FollowSymLinks MultiViews
            AllowOverride All
            Order allow,deny
            allow from all
            Require all granted
        </Directory>

    </VirtualHost>
</IfModule>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
